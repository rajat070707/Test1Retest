import * as tslib_1 from "tslib";
import { Directive, Input, Output, EventEmitter } from '@angular/core';
import { AngularPaginatorService } from '../services/angular-paginator.service';
/**
 * This is the directive where the actual pagination takes place, it provides a sync between the
 * pipes and the pagination component
 */
var AngularPaginatorDirective = /** @class */ (function () {
    /**
     *
     * @param angularPaginatorService serivce for angular paginator
     */
    function AngularPaginatorDirective(angularPaginatorService) {
        var _this = this;
        this.angularPaginatorService = angularPaginatorService;
        this.firstPage = 1;
        this.pages = [];
        /**
         * Emits an event whenever the current page is changed, It emits the current page number
         */
        this.pageChange = new EventEmitter(true);
        // subscribe to changes
        this.subscription = this.angularPaginatorService.change.subscribe(function (id) {
            if (id === _this.id) {
                _this.updatePages();
            }
        });
    }
    /**
     * Navigate to prevoius page
     */
    AngularPaginatorDirective.prototype.toPreviousPage = function () {
        if (this.currentPage > this.firstPage) {
            this.setCurrentPage(this.currentPage - 1);
        }
        return;
    };
    /**
     * Navigate to next page
     */
    AngularPaginatorDirective.prototype.toNextPage = function () {
        if (this.currentPage < this.lastPage) {
            this.setCurrentPage(this.currentPage + 1);
        }
        return;
    };
    /**
     * Navigate to first page
     */
    AngularPaginatorDirective.prototype.toFirstPage = function () {
        this.setCurrentPage(this.firstPage);
        return;
    };
    /**
     * Navigate to last page
     */
    AngularPaginatorDirective.prototype.toLastPage = function () {
        this.setCurrentPage(this.lastPage);
        return;
    };
    /**
     * Sets current page
     *
     * @param page page number to set as currentPage
     */
    AngularPaginatorDirective.prototype.setCurrentPage = function (page) {
        if (page && this.currentPage !== page) {
            this.currentPage = page;
            this.pageChange.emit(page);
        }
        return;
    };
    /**
     * create page object used for template
     *
     * @param number page number
     * @param text page number, text to be displayed
     * @param isActive whether the page is active or not, true for currentPage
     */
    AngularPaginatorDirective.prototype.makePage = function (pageNumber, text, isActive) {
        return {
            number: pageNumber,
            text: text,
            active: isActive
        };
    };
    /**
     *  create page array
     *
     * @param currentPage current page number
     * @param itemsPerPage total items per page
     * @param totalItems no of items for pagination, usually array length
     */
    AngularPaginatorDirective.prototype.getPages = function (currentPage, itemsPerPage, totalItems) {
        var pages = [];
        // Default page limits
        var totalPages = this.lastPage = Math.ceil(totalItems / itemsPerPage);
        var startPage = 1;
        var endPage = totalPages;
        var isMaxSized = this.maxSize && this.maxSize < totalPages;
        // recompute if maxSize
        if (isMaxSized) {
            if (this.rotate) {
                // current page is displayed in the middle of the visible ones
                startPage = Math.max(currentPage - Math.floor(this.maxSize / 2), 1);
                endPage = startPage + this.maxSize - 1;
                // Adjust if limit is exceeded
                if (endPage > totalPages) {
                    endPage = totalPages;
                    startPage = endPage - this.maxSize + 1;
                }
            }
            else {
                // Visible pages are paginated with maxSize
                startPage = (Math.ceil(currentPage / this.maxSize) - 1) * this.maxSize + 1;
                // adjust last page if limit is exceeded
                endPage = Math.min(startPage + this.maxSize - 1, totalPages);
            }
        }
        // add page number links
        for (var pageNumber = startPage; pageNumber <= endPage; pageNumber++) {
            var page = this.makePage(pageNumber, pageNumber, pageNumber === currentPage);
            pages.push(page);
        }
        // add links to move between page sets
        if (isMaxSized && this.maxSize > 0 && (!this.rotate || this.forceEllipses || this.boundaryLinkNumbers)) {
            if (startPage > 1) {
                // need ellipsis for all options unless range is too close to beginning
                if (!this.boundaryLinkNumbers || startPage > 3) {
                    var previousPageSet = this.makePage(startPage - 1, '...', false);
                    pages.unshift(previousPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (startPage === 3) { // need to replace ellipsis when the buttons would be sequential
                        var secondPageLink = this.makePage(2, '2', false);
                        pages.unshift(secondPageLink);
                    }
                    // add the first page
                    var firstPageLink = this.makePage(1, '1', false);
                    pages.unshift(firstPageLink);
                }
            }
            if (endPage < totalPages) {
                // need ellipsis for all options unless range is too close to end
                if (!this.boundaryLinkNumbers || endPage < totalPages - 2) {
                    var nextPageSet = this.makePage(endPage + 1, '...', false);
                    pages.push(nextPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (endPage === totalPages - 2) { // need to replace ellipsis when the buttons would be sequential
                        var secondToLastPageLink = this.makePage(totalPages - 1, totalPages - 1, false);
                        pages.push(secondToLastPageLink);
                    }
                    // add the last page
                    var lastPageLink = this.makePage(totalPages, totalPages, false);
                    pages.push(lastPageLink);
                }
            }
        }
        return pages;
    };
    /**
     * Updates the pagination component
     */
    AngularPaginatorDirective.prototype.updatePages = function () {
        var instance = this.angularPaginatorService.getInstance(this.id);
        var correctedCurrentPage = this.outOfBoundCorrection(instance);
        if (correctedCurrentPage !== instance.currentPage || this.currentPage !== instance.currentPage) {
            this.setCurrentPage(correctedCurrentPage);
        }
        this.pages = this.getPages(instance.currentPage, instance.itemsPerPage, instance.totalItems);
        return;
    };
    /**
     * Check if currentPage is out of bound with totalPages
     *
     * @param instance instance for which the range is to be corrected
     */
    AngularPaginatorDirective.prototype.outOfBoundCorrection = function (instance) {
        var totalPages = Math.ceil(instance.totalItems / instance.itemsPerPage);
        if (totalPages < instance.currentPage && 0 < totalPages) {
            return totalPages;
        }
        else if (instance.currentPage < 1) {
            return 1;
        }
        return instance.currentPage;
    };
    /**
     * check if there is any instance registered with the id
     */
    AngularPaginatorDirective.prototype.isValidId = function () {
        if (!this.angularPaginatorService.getInstance(this.id)) {
            throw new Error('There is no instance registered with id `' + this.id + '`');
        }
        return;
    };
    AngularPaginatorDirective.prototype.ngOnInit = function () {
        this.isValidId();
        this.updatePages();
    };
    AngularPaginatorDirective.prototype.ngOnDestroy = function () {
        /** destroy the subscription when the directive is destroyed */
        this.subscription.unsubscribe();
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], AngularPaginatorDirective.prototype, "boundaryLinks", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], AngularPaginatorDirective.prototype, "directionLinks", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Number)
    ], AngularPaginatorDirective.prototype, "maxSize", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], AngularPaginatorDirective.prototype, "rotate", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], AngularPaginatorDirective.prototype, "boundaryLinkNumbers", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], AngularPaginatorDirective.prototype, "forceEllipses", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], AngularPaginatorDirective.prototype, "id", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], AngularPaginatorDirective.prototype, "pageChange", void 0);
    AngularPaginatorDirective = tslib_1.__decorate([
        Directive({
            selector: 'angularPaginator, [angularPaginator]',
            exportAs: 'angularPaginator'
        }),
        tslib_1.__metadata("design:paramtypes", [AngularPaginatorService])
    ], AngularPaginatorDirective);
    return AngularPaginatorDirective;
}());
export { AngularPaginatorDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1wYWdpbmF0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1wYWdpbmF0b3IvIiwic291cmNlcyI6WyJhcHAvYW5ndWxhci1wYWdpbmF0b3IvZGlyZWN0aXZlcy9hbmd1bGFyLXBhZ2luYXRvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXFCLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBSWhGOzs7R0FHRztBQU1IO0lBZ0RFOzs7T0FHRztJQUNILG1DQUFvQix1QkFBZ0Q7UUFBcEUsaUJBU0M7UUFUbUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQWZwRSxjQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRWQsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUluQjs7V0FFRztRQUNPLGVBQVUsR0FBeUIsSUFBSSxZQUFZLENBQVMsSUFBSSxDQUFDLENBQUM7UUFRMUUsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBQyxFQUFVO1lBQzNFLElBQUksRUFBRSxLQUFLLEtBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2xCLEtBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUNwQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBRUwsQ0FBQztJQUVEOztPQUVHO0lBQ0gsa0RBQWMsR0FBZDtRQUNFLElBQUksSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUMzQztRQUNELE9BQU87SUFDVCxDQUFDO0lBRUQ7O09BRUc7SUFDSCw4Q0FBVSxH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QUU7OzZEQUFpQjtJQVFoQjtRQUFSLEtBQUssRUFBRTs7MEVBQThCO0lBSTdCO1FBQVIsS0FBSyxFQUFFOztvRUFBd0I7SUFLdkI7UUFBUixLQUFLLEVBQUU7O3lEQUFZO0lBWVY7UUFBVCxNQUFNLEVBQUU7MENBQWEsWUFBWTtpRUFBMEM7SUE5Q2pFLHlCQUF5QjtRQUxyQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsc0NBQXNDO1lBQ2hELFFBQVEsRUFBRSxrQkFBa0I7U0FDN0IsQ0FBQztpREFzRDZDLHVCQUF1QjtPQXBEekQseUJBQXlCLENBcVJyQztJQUFELGdDQUFDO0NBQUEsQUFyUkQsSUFxUkM7U0FyUlkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9uRGVzdHJveSwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBbmd1bGFyUGFnaW5hdG9yU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2FuZ3VsYXItcGFnaW5hdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQW5ndWxhclBhZ2luYXRvckluc3RhbmNlLCBQYWdlIH0gZnJvbSAnLi4vb3RoZXJzL2FuZ3VsYXItcGFnaW5hdG9yLmludGVyZmFjZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuLyoqXG4gKiBUaGlzIGlzIHRoZSBkaXJlY3RpdmUgd2hlcmUgdGhlIGFjdHVhbCBwYWdpbmF0aW9uIHRha2VzIHBsYWNlLCBpdCBwcm92aWRlcyBhIHN5bmMgYmV0d2VlbiB0aGVcbiAqIHBpcGVzIGFuZCB0aGUgcGFnaW5hdGlvbiBjb21wb25lbnRcbiAqL1xuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnYW5ndWxhclBhZ2luYXRvciwgW2FuZ3VsYXJQYWdpbmF0b3JdJyxcbiAgZXhwb3J0QXM6ICdhbmd1bGFyUGFnaW5hdG9yJ1xufSlcblxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJQYWdpbmF0b3JEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZGlzcGxheSBGaXJzdCAvIExhc3QgYnV0dG9uc1xuICAgKi9cbiAgQElucHV0KCkgYm91bmRhcnlMaW5rczogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZGlzcGxheSBQcmV2aW91cyAvIE5leHQgYnV0dG9uc1xuICAgKi9cbiAgQElucHV0KCkgZGlyZWN0aW9uTGlua3M6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBMaW1pdCBudW1iZXIgZm9yIHBhZ2luYXRpb24gc2l6ZSwgaS5lLiwgdGhlIG1heGltdW0gcGFnZSBudW1iZXJzIHRvIGJlIGRpc3BsYXllZFxuICAgKi9cbiAgQElucHV0KCkgbWF4U2l6ZTogbnVtYmVyO1xuICAvKipcbiAgICogV2hldGhlciB0byBrZWVwIGN1cnJlbnQgcGFnZSBpbiB0aGUgbWlkZGxlIG9mIHRoZSB2aXNpYmxlIG9uZXNcbiAgICovXG4gIEBJbnB1dCgpIHJvdGF0ZTogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gYWx3YXlzIGRpc3BsYXkgdGhlIGZpcnN0IGFuZCBsYXN0IHBhZ2UgbnVtYmVycy5cbiAgICogSWYgbWF4LXNpemUgaXMgc21hbGxlciB0aGFuIHRoZSBudW1iZXIgb2YgcGFnZXMsIHRoZW4gdGhlIGZpcnN0IGFuZCBsYXN0IHBhZ2UgbnVtYmVycyBhcmUgc3RpbGwgc2hvd24gd2l0aCBlbGxpcHNlc1xuICAgKiBpbi1iZXR3ZWVuIGFzIG5lY2Vzc2FyeS4gTk9URTogbWF4LXNpemUgcmVmZXJzIHRvIHRoZSBjZW50ZXIgb2YgdGhlIHJhbmdlLlxuICAgKiBUaGlzIG9wdGlvbiBtYXkgYWRkIHVwIHRvIDIgbW9yZSBudW1iZXJzIG9uIGVhY2ggc2lkZSBvZiB0aGUgZGlzcGxheWVkIHJhbmdlIGZvciB0aGUgZW5kIHZhbHVlIGFuZFxuICAgKiB3aGF0IHdvdWxkIGJlIGFuIGVsbGlwc2lzIGJ1dCBpcyByZXBsYWNlZCBieSBhIG51bWJlciBiZWNhdXNlIGl0IGlzIHNlcXVlbnRpYWxcbiAgICovXG4gIEBJbnB1dCgpIGJvdW5kYXJ5TGlua051bWJlcnM6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBBbHNvIGRpc3BsYXlzIGVsbGlwc2VzIHdoZW4gcm90YXRlIGlzIHRydWUgYW5kIG1heFNpemUgaXMgc21hbGxlciB0aGFuIHRoZSBudW1iZXIgb2YgcGFnZXMgZm9yY2VFbGxpcHNlc1xuICAgKi9cbiAgQElucHV0KCkgZm9yY2VFbGxpcHNlczogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFVzZSB1bmlxdWUgaWQgd2hlbiBtdWx0aXBsZSBwYWdpbmF0aW9ucyBhcmUgYmVpbmcgdXNlZCBvbiB0aGUgc2FtZSBwYWdlLlxuICAgKiBCeSBEZWZhdWx0IFBhZ2luYXRvciB1c2VzIGlkIGBBTkdVTEFSX1BBR0lOQVRPUl9ERUZBVUxUYFxuICAgKi9cbiAgQElucHV0KCkgaWQ6IHN0cmluZztcblxuICBjdXJyZW50UGFnZTogbnVtYmVyO1xuICBmaXJzdFBhZ2UgPSAxO1xuICBsYXN0UGFnZTogbnVtYmVyO1xuICBwYWdlczogUGFnZVtdID0gW107XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICAvKipcbiAgICogRW1pdHMgYW4gZXZlbnQgd2hlbmV2ZXIgdGhlIGN1cnJlbnQgcGFnZSBpcyBjaGFuZ2VkLCBJdCBlbWl0cyB0aGUgY3VycmVudCBwYWdlIG51bWJlclxuICAgKi9cbiAgQE91dHB1dCgpIHBhZ2VDaGFuZ2U6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KHRydWUpO1xuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gYW5ndWxhclBhZ2luYXRvclNlcnZpY2Ugc2VyaXZjZSBmb3IgYW5ndWxhciBwYWdpbmF0b3JcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYW5ndWxhclBhZ2luYXRvclNlcnZpY2U6IEFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlKSB7XG5cbiAgICAvLyBzdWJzY3JpYmUgdG8gY2hhbmdlc1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5hbmd1bGFyUGFnaW5hdG9yU2VydmljZS5jaGFuZ2Uuc3Vic2NyaWJlKChpZDogc3RyaW5nKSA9PiB7XG4gICAgICBpZiAoaWQgPT09IHRoaXMuaWQpIHtcbiAgICAgICAgdGhpcy51cGRhdGVQYWdlcygpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgdG8gcHJldm9pdXMgcGFnZVxuICAgKi9cbiAgdG9QcmV2aW91c1BhZ2UoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY3VycmVudFBhZ2UgPiB0aGlzLmZpcnN0UGFnZSkge1xuICAgICAgdGhpcy5zZXRDdXJyZW50UGFnZSh0aGlzLmN1cnJlbnRQYWdlIC0gMSk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYXZpZ2F0ZSB0byBuZXh0IHBhZ2VcbiAgICovXG4gIHRvTmV4dFBhZ2UoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY3VycmVudFBhZ2UgPCB0aGlzLmxhc3RQYWdlKSB7XG4gICAgICB0aGlzLnNldEN1cnJlbnRQYWdlKHRoaXMuY3VycmVudFBhZ2UgKyAxKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIE5hdmlnYXRlIHRvIGZpcnN0IHBhZ2VcbiAgICovXG4gIHRvRmlyc3RQYWdlKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UodGhpcy5maXJzdFBhZ2UpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYXZpZ2F0ZSB0byBsYXN0IHBhZ2VcbiAgICovXG4gIHRvTGFzdFBhZ2UoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRDdXJyZW50UGFnZSh0aGlzLmxhc3RQYWdlKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogU2V0cyBjdXJyZW50IHBhZ2VcbiAgICpcbiAgICogQHBhcmFtIHBhZ2UgcGFnZSBudW1iZXIgdG8gc2V0IGFzIGN1cnJlbnRQYWdlXG4gICAqL1xuICBzZXRDdXJyZW50UGFnZShwYWdlOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAocGFnZSAmJiB0aGlzLmN1cnJlbnRQYWdlICE9PSBwYWdlKSB7XG4gICAgICB0aGlzLmN1cnJlbnRQYWdlID0gcGFnZTtcbiAgICAgIHRoaXMucGFnZUNoYW5nZS5lbWl0KHBhZ2UpO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogY3JlYXRlIHBhZ2Ugb2JqZWN0IHVzZWQgZm9yIHRlbXBsYXRlXG4gICAqXG4gICAqIEBwYXJhbSBudW1iZXIgcGFnZSBudW1iZXJcbiAgICogQHBhcmFtIHRleHQgcGFnZSBudW1iZXIsIHRleHQgdG8gYmUgZGlzcGxheWVkXG4gICAqIEBwYXJhbSBpc0FjdGl2ZSB3aGV0aGVyIHRoZSBwYWdlIGlzIGFjdGl2ZSBvciBub3QsIHRydWUgZm9yIGN1cnJlbnRQYWdlXG4gICAqL1xuICBtYWtlUGFnZShwYWdlTnVtYmVyOiBudW1iZXIsIHRleHQ6IGFueSwgaXNBY3RpdmU6IGJvb2xlYW4pOiBhbnkge1xuICAgIHJldHVybiB7XG4gICAgICBudW1iZXI6IHBhZ2VOdW1iZXIsXG4gICAgICB0ZXh0LFxuICAgICAgYWN0aXZlOiBpc0FjdGl2ZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogIGNyZWF0ZSBwYWdlIGFycmF5XG4gICAqXG4gICAqIEBwYXJhbSBjdXJyZW50UGFnZSBjdXJyZW50IHBhZ2UgbnVtYmVyXG4gICAqIEBwYXJhbSBpdGVtc1BlclBhZ2UgdG90YWwgaXRlbXMgcGVyIHBhZ2VcbiAgICogQHBhcmFtIHRvdGFsSXRlbXMgbm8gb2YgaXRlbXMgZm9yIHBhZ2luYXRpb24sIHVzdWFsbHkgYXJyYXkgbGVuZ3RoXG4gICAqL1xuICBnZXRQYWdlcyhjdXJyZW50UGFnZTogbnVtYmVyLCBpdGVtc1BlclBhZ2U6IG51bWJlciwgdG90YWxJdGVtczogbnVtYmVyKTogYW55IHtcbiAgICBjb25zdCBwYWdlczogYW55ID0gW107XG5cbiAgICAvLyBEZWZhdWx0IHBhZ2UgbGltaXRzXG4gICAgY29uc3QgdG90YWxQYWdlczogbnVtYmVyID0gdGhpcy5sYXN0UGFnZSA9IE1hdGguY2VpbCh0b3RhbEl0ZW1zIC8gaXRlbXNQZXJQYWdlKTtcblxuICAgIGxldCBzdGFydFBhZ2UgPSAxO1xuICAgIGxldCBlbmRQYWdlOiBudW1iZXIgPSB0b3RhbFBhZ2VzO1xuICAgIGNvbnN0IGlzTWF4U2l6ZWQ6IGJvb2xlYW4gPSB0aGlzLm1heFNpemUgJiYgdGhpcy5tYXhTaXplIDwgdG90YWxQYWdlcztcblxuICAgIC8vIHJlY29tcHV0ZSBpZiBtYXhTaXplXG4gICAgaWYgKGlzTWF4U2l6ZWQpIHtcblxuICAgICAgaWYgKHRoaXMucm90YXRlKSB7XG5cbiAgICAgICAgLy8gY3VycmVudCBwYWdlIGlzIGRpc3BsYXllZCBpbiB0aGUgbWlkZGxlIG9mIHRoZSB2aXNpYmxlIG9uZXNcbiAgICAgICAgc3RhcnRQYWdlID0gTWF0aC5tYXgoY3VycmVudFBhZ2UgLSBNYXRoLmZsb29yKHRoaXMubWF4U2l6ZSAvIDIpLCAxKTtcbiAgICAgICAgZW5kUGFnZSA9IHN0YXJ0UGFnZSArIHRoaXMubWF4U2l6ZSAtIDE7XG5cbiAgICAgICAgLy8gQWRqdXN0IGlmIGxpbWl0IGlzIGV4Y2VlZGVkXG4gICAgICAgIGlmIChlbmRQYWdlID4gdG90YWxQYWdlcykge1xuICAgICAgICAgIGVuZFBhZ2UgPSB0b3RhbFBhZ2VzO1xuICAgICAgICAgIHN0YXJ0UGFnZSA9IGVuZFBhZ2UgLSB0aGlzLm1heFNpemUgKyAxO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBWaXNpYmxlIHBhZ2VzIGFyZSBwYWdpbmF0ZWQgd2l0aCBtYXhTaXplXG4gICAgICAgIHN0YXJ0UGFnZSA9IChNYXRoLmNlaWwoY3VycmVudFBhZ2UgLyB0aGlzLm1heFNpemUpIC0gMSkgKiB0aGlzLm1heFNpemUgKyAxO1xuXG4gICAgICAgIC8vIGFkanVzdCBsYXN0IHBhZ2UgaWYgbGltaXQgaXMgZXhjZWVkZWRcbiAgICAgICAgZW5kUGFnZSA9IE1hdGgubWluKHN0YXJ0UGFnZSArIHRoaXMubWF4U2l6ZSAtIDEsIHRvdGFsUGFnZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGFkZCBwYWdlIG51bWJlciBsaW5rc1xuICAgIGZvciAobGV0IHBhZ2VOdW1iZXIgPSBzdGFydFBhZ2U7IHBhZ2VOdW1iZXIgPD0gZW5kUGFnZTsgcGFnZU51bWJlcisrKSB7XG4gICAgICBjb25zdCBwYWdlID0gdGhpcy5tYWtlUGFnZShwYWdlTnVtYmVyLCBwYWdlTnVtYmVyLCBwYWdlTnVtYmVyID09PSBjdXJyZW50UGFnZSk7XG4gICAgICBwYWdlcy5wdXNoKHBhZ2UpO1xuICAgIH1cblxuICAgIC8vIGFkZCBsaW5rcyB0byBtb3ZlIGJldHdlZW4gcGFnZSBzZXRzXG4gICAgaWYgKGlzTWF4U2l6ZWQgJiYgdGhpcy5tYXhTaXplID4gMCAmJiAoIXRoaXMucm90YXRlIHx8IHRoaXMuZm9yY2VFbGxpcHNlcyB8fCB0aGlzLmJvdW5kYXJ5TGlua051bWJlcnMpKSB7XG4gICAgICBpZiAoc3RhcnRQYWdlID4gMSkge1xuXG4gICAgICAgIC8vIG5lZWQgZWxsaXBzaXMgZm9yIGFsbCBvcHRpb25zIHVubGVzcyByYW5nZSBpcyB0b28gY2xvc2UgdG8gYmVnaW5uaW5nXG4gICAgICAgIGlmICghdGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzIHx8IHN0YXJ0UGFnZSA+IDMpIHtcbiAgICAgICAgICBjb25zdCBwcmV2aW91c1BhZ2VTZXQgPSB0aGlzLm1ha2VQYWdlKHN0YXJ0UGFnZSAtIDEsICcuLi4nLCBmYWxzZSk7XG4gICAgICAgICAgcGFnZXMudW5zaGlmdChwcmV2aW91c1BhZ2VTZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuYm91bmRhcnlMaW5rTnVtYmVycykge1xuXG4gICAgICAgICAgaWYgKHN0YXJ0UGFnZSA9PT0gMykgeyAvLyBuZWVkIHRvIHJlcGxhY2UgZWxsaXBzaXMgd2hlbiB0aGUgYnV0dG9ucyB3b3VsZCBiZSBzZXF1ZW50aWFsXG4gICAgICAgICAgICBjb25zdCBzZWNvbmRQYWdlTGluayA9IHRoaXMubWFrZVBhZ2UoMiwgJzInLCBmYWxzZSk7XG4gICAgICAgICAgICBwYWdlcy51bnNoaWZ0KHNlY29uZFBhZ2VMaW5rKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBhZGQgdGhlIGZpcnN0IHBhZ2VcbiAgICAgICAgICBjb25zdCBmaXJzdFBhZ2VMaW5rID0gdGhpcy5tYWtlUGFnZSgxLCAnMScsIGZhbHNlKTtcbiAgICAgICAgICBwYWdlcy51bnNoaWZ0KGZpcnN0UGFnZUxpbmspO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChlbmRQYWdlIDwgdG90YWxQYWdlcykge1xuXG4gICAgICAgIC8vIG5lZWQgZWxsaXBzaXMgZm9yIGFsbCBvcHRpb25zIHVubGVzcyByYW5nZSBpcyB0b28gY2xvc2UgdG8gZW5kXG4gICAgICAgIGlmICghdGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzIHx8IGVuZFBhZ2UgPCB0b3RhbFBhZ2VzIC0gMikge1xuICAgICAgICAgIGNvbnN0IG5leHRQYWdlU2V0ID0gdGhpcy5tYWtlUGFnZShlbmRQYWdlICsgMSwgJy4uLicsIGZhbHNlKTtcbiAgICAgICAgICBwYWdlcy5wdXNoKG5leHRQYWdlU2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmJvdW5kYXJ5TGlua051bWJlcnMpIHtcblxuICAgICAgICAgIGlmIChlbmRQYWdlID09PSB0b3RhbFBhZ2VzIC0gMikgeyAvLyBuZWVkIHRvIHJlcGxhY2UgZWxsaXBzaXMgd2hlbiB0aGUgYnV0dG9ucyB3b3VsZCBiZSBzZXF1ZW50aWFsXG4gICAgICAgICAgICBjb25zdCBzZWNvbmRUb0xhc3RQYWdlTGluayA9IHRoaXMubWFrZVBhZ2UodG90YWxQYWdlcyAtIDEsIHRvdGFsUGFnZXMgLSAxLCBmYWxzZSk7XG4gICAgICAgICAgICBwYWdlcy5wdXNoKHNlY29uZFRvTGFzdFBhZ2VMaW5rKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBhZGQgdGhlIGxhc3QgcGFnZVxuICAgICAgICAgIGNvbnN0IGxhc3RQYWdlTGluayA9IHRoaXMubWFrZVBhZ2UodG90YWxQYWdlcywgdG90YWxQYWdlcywgZmFsc2UpO1xuICAgICAgICAgIHBhZ2VzLnB1c2gobGFzdFBhZ2VMaW5rKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFnZXM7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgcGFnaW5hdGlvbiBjb21wb25lbnRcbiAgICovXG4gIHVwZGF0ZVBhZ2VzKCk6IHZvaWQge1xuICAgIGNvbnN0IGluc3RhbmNlOiBBbmd1bGFyUGFnaW5hdG9ySW5zdGFuY2UgPSB0aGlzLmFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlLmdldEluc3RhbmNlKHRoaXMuaWQpO1xuXG4gICAgY29uc3QgY29ycmVjdGVkQ3VycmVudFBhZ2UgPSB0aGlzLm91dE9mQm91bmRDb3JyZWN0aW9uKGluc3RhbmNlKTtcblxuICAgIGlmIChjb3JyZWN0ZWRDdXJyZW50UGFnZSAhPT0gaW5zdGFuY2UuY3VycmVudFBhZ2UgfHwgdGhpcy5jdXJyZW50UGFnZSAhPT0gaW5zdGFuY2UuY3VycmVudFBhZ2UpIHtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UoY29ycmVjdGVkQ3VycmVudFBhZ2UpO1xuICAgIH1cblxuICAgIHRoaXMucGFnZXMgPSB0aGlzLmdldFBhZ2VzKGluc3RhbmNlLmN1cnJlbnRQYWdlLCBpbnN0YW5jZS5pdGVtc1BlclBhZ2UsIGluc3RhbmNlLnRvdGFsSXRlbXMpO1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGN1cnJlbnRQYWdlIGlzIG91dCBvZiBib3VuZCB3aXRoIHRvdGFsUGFnZXNcbiAgICpcbiAgICogQHBhcmFtIGluc3RhbmNlIGluc3RhbmNlIGZvciB3aGljaCB0aGUgcmFuZ2UgaXMgdG8gYmUgY29ycmVjdGVkXG4gICAqL1xuICBvdXRPZkJvdW5kQ29ycmVjdGlvbihpbnN0YW5jZTogQW5ndWxhclBhZ2luYXRvckluc3RhbmNlKTogbnVtYmVyIHtcblxuICAgIGNvbnN0IHRvdGFsUGFnZXMgPSBNYXRoLmNlaWwoaW5zdGFuY2UudG90YWxJdGVtcyAvIGluc3RhbmNlLml0ZW1zUGVyUGFnZSk7XG5cbiAgICBpZiAodG90YWxQYWdlcyA8IGluc3RhbmNlLmN1cnJlbnRQYWdlICYmIDAgPCB0b3RhbFBhZ2VzKSB7XG4gICAgICByZXR1cm4gdG90YWxQYWdlcztcbiAgICB9IGVsc2UgaWYgKGluc3RhbmNlLmN1cnJlbnRQYWdlIDwgMSkge1xuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3RhbmNlLmN1cnJlbnRQYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIGNoZWNrIGlmIHRoZXJlIGlzIGFueSBpbnN0YW5jZSByZWdpc3RlcmVkIHdpdGggdGhlIGlkXG4gICAqL1xuICBpc1ZhbGlkSWQoKTogdm9pZCB7XG5cbiAgICBpZiAoIXRoaXMuYW5ndWxhclBhZ2luYXRvclNlcnZpY2UuZ2V0SW5zdGFuY2UodGhpcy5pZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gaW5zdGFuY2UgcmVnaXN0ZXJlZCB3aXRoIGlkIGAnICsgdGhpcy5pZCArICdgJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pc1ZhbGlkSWQoKTtcbiAgICB0aGlzLnVwZGF0ZVBhZ2VzKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICAvKiogZGVzdHJveSB0aGUgc3Vic2NyaXB0aW9uIHdoZW4gdGhlIGRpcmVjdGl2ZSBpcyBkZXN0cm95ZWQgKi9cbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbn1cbiJdfQ==