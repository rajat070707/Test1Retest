import * as tslib_1 from "tslib";
import { Directive, Input, Output, EventEmitter } from '@angular/core';
import { AngularPaginatorService } from '../services/angular-paginator.service';
/**
 * This is the directive where the actual pagination takes place, it provides a sync between the
 * pipes and the pagination component
 */
let AngularPaginatorDirective = class AngularPaginatorDirective {
    /**
     *
     * @param angularPaginatorService serivce for angular paginator
     */
    constructor(angularPaginatorService) {
        this.angularPaginatorService = angularPaginatorService;
        this.firstPage = 1;
        this.pages = [];
        /**
         * Emits an event whenever the current page is changed, It emits the current page number
         */
        this.pageChange = new EventEmitter(true);
        // subscribe to changes
        this.subscription = this.angularPaginatorService.change.subscribe((id) => {
            if (id === this.id) {
                this.updatePages();
            }
        });
    }
    /**
     * Navigate to prevoius page
     */
    toPreviousPage() {
        if (this.currentPage > this.firstPage) {
            this.setCurrentPage(this.currentPage - 1);
        }
        return;
    }
    /**
     * Navigate to next page
     */
    toNextPage() {
        if (this.currentPage < this.lastPage) {
            this.setCurrentPage(this.currentPage + 1);
        }
        return;
    }
    /**
     * Navigate to first page
     */
    toFirstPage() {
        this.setCurrentPage(this.firstPage);
        return;
    }
    /**
     * Navigate to last page
     */
    toLastPage() {
        this.setCurrentPage(this.lastPage);
        return;
    }
    /**
     * Sets current page
     *
     * @param page page number to set as currentPage
     */
    setCurrentPage(page) {
        if (page && this.currentPage !== page) {
            this.currentPage = page;
            this.pageChange.emit(page);
        }
        return;
    }
    /**
     * create page object used for template
     *
     * @param number page number
     * @param text page number, text to be displayed
     * @param isActive whether the page is active or not, true for currentPage
     */
    makePage(pageNumber, text, isActive) {
        return {
            number: pageNumber,
            text,
            active: isActive
        };
    }
    /**
     *  create page array
     *
     * @param currentPage current page number
     * @param itemsPerPage total items per page
     * @param totalItems no of items for pagination, usually array length
     */
    getPages(currentPage, itemsPerPage, totalItems) {
        const pages = [];
        // Default page limits
        const totalPages = this.lastPage = Math.ceil(totalItems / itemsPerPage);
        let startPage = 1;
        let endPage = totalPages;
        const isMaxSized = this.maxSize && this.maxSize < totalPages;
        // recompute if maxSize
        if (isMaxSized) {
            if (this.rotate) {
                // current page is displayed in the middle of the visible ones
                startPage = Math.max(currentPage - Math.floor(this.maxSize / 2), 1);
                endPage = startPage + this.maxSize - 1;
                // Adjust if limit is exceeded
                if (endPage > totalPages) {
                    endPage = totalPages;
                    startPage = endPage - this.maxSize + 1;
                }
            }
            else {
                // Visible pages are paginated with maxSize
                startPage = (Math.ceil(currentPage / this.maxSize) - 1) * this.maxSize + 1;
                // adjust last page if limit is exceeded
                endPage = Math.min(startPage + this.maxSize - 1, totalPages);
            }
        }
        // add page number links
        for (let pageNumber = startPage; pageNumber <= endPage; pageNumber++) {
            const page = this.makePage(pageNumber, pageNumber, pageNumber === currentPage);
            pages.push(page);
        }
        // add links to move between page sets
        if (isMaxSized && this.maxSize > 0 && (!this.rotate || this.forceEllipses || this.boundaryLinkNumbers)) {
            if (startPage > 1) {
                // need ellipsis for all options unless range is too close to beginning
                if (!this.boundaryLinkNumbers || startPage > 3) {
                    const previousPageSet = this.makePage(startPage - 1, '...', false);
                    pages.unshift(previousPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (startPage === 3) { // need to replace ellipsis when the buttons would be sequential
                        const secondPageLink = this.makePage(2, '2', false);
                        pages.unshift(secondPageLink);
                    }
                    // add the first page
                    const firstPageLink = this.makePage(1, '1', false);
                    pages.unshift(firstPageLink);
                }
            }
            if (endPage < totalPages) {
                // need ellipsis for all options unless range is too close to end
                if (!this.boundaryLinkNumbers || endPage < totalPages - 2) {
                    const nextPageSet = this.makePage(endPage + 1, '...', false);
                    pages.push(nextPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (endPage === totalPages - 2) { // need to replace ellipsis when the buttons would be sequential
                        const secondToLastPageLink = this.makePage(totalPages - 1, totalPages - 1, false);
                        pages.push(secondToLastPageLink);
                    }
                    // add the last page
                    const lastPageLink = this.makePage(totalPages, totalPages, false);
                    pages.push(lastPageLink);
                }
            }
        }
        return pages;
    }
    /**
     * Updates the pagination component
     */
    updatePages() {
        const instance = this.angularPaginatorService.getInstance(this.id);
        const correctedCurrentPage = this.outOfBoundCorrection(instance);
        if (correctedCurrentPage !== instance.currentPage || this.currentPage !== instance.currentPage) {
            this.setCurrentPage(correctedCurrentPage);
        }
        this.pages = this.getPages(instance.currentPage, instance.itemsPerPage, instance.totalItems);
        return;
    }
    /**
     * Check if currentPage is out of bound with totalPages
     *
     * @param instance instance for which the range is to be corrected
     */
    outOfBoundCorrection(instance) {
        const totalPages = Math.ceil(instance.totalItems / instance.itemsPerPage);
        if (totalPages < instance.currentPage && 0 < totalPages) {
            return totalPages;
        }
        else if (instance.currentPage < 1) {
            return 1;
        }
        return instance.currentPage;
    }
    /**
     * check if there is any instance registered with the id
     */
    isValidId() {
        if (!this.angularPaginatorService.getInstance(this.id)) {
            throw new Error('There is no instance registered with id `' + this.id + '`');
        }
        return;
    }
    ngOnInit() {
        this.isValidId();
        this.updatePages();
    }
    ngOnDestroy() {
        /** destroy the subscription when the directive is destroyed */
        this.subscription.unsubscribe();
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], AngularPaginatorDirective.prototype, "boundaryLinks", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], AngularPaginatorDirective.prototype, "directionLinks", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Number)
], AngularPaginatorDirective.prototype, "maxSize", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], AngularPaginatorDirective.prototype, "rotate", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], AngularPaginatorDirective.prototype, "boundaryLinkNumbers", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], AngularPaginatorDirective.prototype, "forceEllipses", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], AngularPaginatorDirective.prototype, "id", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], AngularPaginatorDirective.prototype, "pageChange", void 0);
AngularPaginatorDirective = tslib_1.__decorate([
    Directive({
        selector: 'angularPaginator, [angularPaginator]',
        exportAs: 'angularPaginator'
    }),
    tslib_1.__metadata("design:paramtypes", [AngularPaginatorService])
], AngularPaginatorDirective);
export { AngularPaginatorDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1wYWdpbmF0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1wYWdpbmF0b3IvIiwic291cmNlcyI6WyJhcHAvYW5ndWxhci1wYWdpbmF0b3IvZGlyZWN0aXZlcy9hbmd1bGFyLXBhZ2luYXRvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXFCLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBSWhGOzs7R0FHRztBQU1ILElBQWEseUJBQXlCLEdBQXRDLE1BQWEseUJBQXlCO0lBZ0RwQzs7O09BR0c7SUFDSCxZQUFvQix1QkFBZ0Q7UUFBaEQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQWZwRSxjQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRWQsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUluQjs7V0FFRztRQUNPLGVBQVUsR0FBeUIsSUFBSSxZQUFZLENBQVMsSUFBSSxDQUFDLENBQUM7UUFRMUUsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFVLEVBQUUsRUFBRTtZQUMvRSxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNsQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDcEI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7SUFFRDs7T0FFRztJQUNILGNBQWM7UUFDWixJQUFJLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNyQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDM0M7UUFDRCxPQUFPO0lBQ1QsQ0FBQztJ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QUFJN0I7SUFBUixLQUFLLEVBQUU7O2dFQUF3QjtBQUt2QjtJQUFSLEtBQUssRUFBRTs7cURBQVk7QUFZVjtJQUFULE1BQU0sRUFBRTtzQ0FBYSxZQUFZOzZEQUEwQztBQTlDakUseUJBQXlCO0lBTHJDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxzQ0FBc0M7UUFDaEQsUUFBUSxFQUFFLGtCQUFrQjtLQUM3QixDQUFDOzZDQXNENkMsdUJBQXVCO0dBcER6RCx5QkFBeUIsQ0FxUnJDO1NBclJZLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPbkRlc3Ryb3ksIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQW5ndWxhclBhZ2luYXRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hbmd1bGFyLXBhZ2luYXRvci5zZXJ2aWNlJztcbmltcG9ydCB7IEFuZ3VsYXJQYWdpbmF0b3JJbnN0YW5jZSwgUGFnZSB9IGZyb20gJy4uL290aGVycy9hbmd1bGFyLXBhZ2luYXRvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbi8qKlxuICogVGhpcyBpcyB0aGUgZGlyZWN0aXZlIHdoZXJlIHRoZSBhY3R1YWwgcGFnaW5hdGlvbiB0YWtlcyBwbGFjZSwgaXQgcHJvdmlkZXMgYSBzeW5jIGJldHdlZW4gdGhlXG4gKiBwaXBlcyBhbmQgdGhlIHBhZ2luYXRpb24gY29tcG9uZW50XG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ2FuZ3VsYXJQYWdpbmF0b3IsIFthbmd1bGFyUGFnaW5hdG9yXScsXG4gIGV4cG9ydEFzOiAnYW5ndWxhclBhZ2luYXRvcidcbn0pXG5cbmV4cG9ydCBjbGFzcyBBbmd1bGFyUGFnaW5hdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGRpc3BsYXkgRmlyc3QgLyBMYXN0IGJ1dHRvbnNcbiAgICovXG4gIEBJbnB1dCgpIGJvdW5kYXJ5TGlua3M6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGRpc3BsYXkgUHJldmlvdXMgLyBOZXh0IGJ1dHRvbnNcbiAgICovXG4gIEBJbnB1dCgpIGRpcmVjdGlvbkxpbmtzOiBib29sZWFuO1xuICAvKipcbiAgICogTGltaXQgbnVtYmVyIGZvciBwYWdpbmF0aW9uIHNpemUsIGkuZS4sIHRoZSBtYXhpbXVtIHBhZ2UgbnVtYmVycyB0byBiZSBkaXNwbGF5ZWRcbiAgICovXG4gIEBJbnB1dCgpIG1heFNpemU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8ga2VlcCBjdXJyZW50IHBhZ2UgaW4gdGhlIG1pZGRsZSBvZiB0aGUgdmlzaWJsZSBvbmVzXG4gICAqL1xuICBASW5wdXQoKSByb3RhdGU6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGFsd2F5cyBkaXNwbGF5IHRoZSBmaXJzdCBhbmQgbGFzdCBwYWdlIG51bWJlcnMuXG4gICAqIElmIG1heC1zaXplIGlzIHNtYWxsZXIgdGhhbiB0aGUgbnVtYmVyIG9mIHBhZ2VzLCB0aGVuIHRoZSBmaXJzdCBhbmQgbGFzdCBwYWdlIG51bWJlcnMgYXJlIHN0aWxsIHNob3duIHdpdGggZWxsaXBzZXNcbiAgICogaW4tYmV0d2VlbiBhcyBuZWNlc3NhcnkuIE5PVEU6IG1heC1zaXplIHJlZmVycyB0byB0aGUgY2VudGVyIG9mIHRoZSByYW5nZS5cbiAgICogVGhpcyBvcHRpb24gbWF5IGFkZCB1cCB0byAyIG1vcmUgbnVtYmVycyBvbiBlYWNoIHNpZGUgb2YgdGhlIGRpc3BsYXllZCByYW5nZSBmb3IgdGhlIGVuZCB2YWx1ZSBhbmRcbiAgICogd2hhdCB3b3VsZCBiZSBhbiBlbGxpcHNpcyBidXQgaXMgcmVwbGFjZWQgYnkgYSBudW1iZXIgYmVjYXVzZSBpdCBpcyBzZXF1ZW50aWFsXG4gICAqL1xuICBASW5wdXQoKSBib3VuZGFyeUxpbmtOdW1iZXJzOiBib29sZWFuO1xuICAvKipcbiAgICogQWxzbyBkaXNwbGF5cyBlbGxpcHNlcyB3aGVuIHJvdGF0ZSBpcyB0cnVlIGFuZCBtYXhTaXplIGlzIHNtYWxsZXIgdGhhbiB0aGUgbnVtYmVyIG9mIHBhZ2VzIGZvcmNlRWxsaXBzZXNcbiAgICovXG4gIEBJbnB1dCgpIGZvcmNlRWxsaXBzZXM6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBVc2UgdW5pcXVlIGlkIHdoZW4gbXVsdGlwbGUgcGFnaW5hdGlvbnMgYXJlIGJlaW5nIHVzZWQgb24gdGhlIHNhbWUgcGFnZS5cbiAgICogQnkgRGVmYXVsdCBQYWdpbmF0b3IgdXNlcyBpZCBgQU5HVUxBUl9QQUdJTkFUT1JfREVGQVVMVGBcbiAgICovXG4gIEBJbnB1dCgpIGlkOiBzdHJpbmc7XG5cbiAgY3VycmVudFBhZ2U6IG51bWJlcjtcbiAgZmlyc3RQYWdlID0gMTtcbiAgbGFzdFBhZ2U6IG51bWJlcjtcbiAgcGFnZXM6IFBhZ2VbXSA9IFtdO1xuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgLyoqXG4gICAqIEVtaXRzIGFuIGV2ZW50IHdoZW5ldmVyIHRoZSBjdXJyZW50IHBhZ2UgaXMgY2hhbmdlZCwgSXQgZW1pdHMgdGhlIGN1cnJlbnQgcGFnZSBudW1iZXJcbiAgICovXG4gIEBPdXRwdXQoKSBwYWdlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPih0cnVlKTtcblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlIHNlcml2Y2UgZm9yIGFuZ3VsYXIgcGFnaW5hdG9yXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlOiBBbmd1bGFyUGFnaW5hdG9yU2VydmljZSkge1xuXG4gICAgLy8gc3Vic2NyaWJlIHRvIGNoYW5nZXNcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuYW5ndWxhclBhZ2luYXRvclNlcnZpY2UuY2hhbmdlLnN1YnNjcmliZSgoaWQ6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKGlkID09PSB0aGlzLmlkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlUGFnZXMoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICB9XG5cbiAgLyoqXG4gICAqIE5hdmlnYXRlIHRvIHByZXZvaXVzIHBhZ2VcbiAgICovXG4gIHRvUHJldmlvdXNQYWdlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlID4gdGhpcy5maXJzdFBhZ2UpIHtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UodGhpcy5jdXJyZW50UGFnZSAtIDEpO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgdG8gbmV4dCBwYWdlXG4gICAqL1xuICB0b05leHRQYWdlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlIDwgdGhpcy5sYXN0UGFnZSkge1xuICAgICAgdGhpcy5zZXRDdXJyZW50UGFnZSh0aGlzLmN1cnJlbnRQYWdlICsgMSk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYXZpZ2F0ZSB0byBmaXJzdCBwYWdlXG4gICAqL1xuICB0b0ZpcnN0UGFnZSgpOiB2b2lkIHtcbiAgICB0aGlzLnNldEN1cnJlbnRQYWdlKHRoaXMuZmlyc3RQYWdlKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgdG8gbGFzdCBwYWdlXG4gICAqL1xuICB0b0xhc3RQYWdlKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UodGhpcy5sYXN0UGFnZSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgY3VycmVudCBwYWdlXG4gICAqXG4gICAqIEBwYXJhbSBwYWdlIHBhZ2UgbnVtYmVyIHRvIHNldCBhcyBjdXJyZW50UGFnZVxuICAgKi9cbiAgc2V0Q3VycmVudFBhZ2UocGFnZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHBhZ2UgJiYgdGhpcy5jdXJyZW50UGFnZSAhPT0gcGFnZSkge1xuICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IHBhZ2U7XG4gICAgICB0aGlzLnBhZ2VDaGFuZ2UuZW1pdChwYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIGNyZWF0ZSBwYWdlIG9iamVjdCB1c2VkIGZvciB0ZW1wbGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbnVtYmVyIHBhZ2UgbnVtYmVyXG4gICAqIEBwYXJhbSB0ZXh0IHBhZ2UgbnVtYmVyLCB0ZXh0IHRvIGJlIGRpc3BsYXllZFxuICAgKiBAcGFyYW0gaXNBY3RpdmUgd2hldGhlciB0aGUgcGFnZSBpcyBhY3RpdmUgb3Igbm90LCB0cnVlIGZvciBjdXJyZW50UGFnZVxuICAgKi9cbiAgbWFrZVBhZ2UocGFnZU51bWJlcjogbnVtYmVyLCB0ZXh0OiBhbnksIGlzQWN0aXZlOiBib29sZWFuKTogYW55IHtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtYmVyOiBwYWdlTnVtYmVyLFxuICAgICAgdGV4dCxcbiAgICAgIGFjdGl2ZTogaXNBY3RpdmVcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqICBjcmVhdGUgcGFnZSBhcnJheVxuICAgKlxuICAgKiBAcGFyYW0gY3VycmVudFBhZ2UgY3VycmVudCBwYWdlIG51bWJlclxuICAgKiBAcGFyYW0gaXRlbXNQZXJQYWdlIHRvdGFsIGl0ZW1zIHBlciBwYWdlXG4gICAqIEBwYXJhbSB0b3RhbEl0ZW1zIG5vIG9mIGl0ZW1zIGZvciBwYWdpbmF0aW9uLCB1c3VhbGx5IGFycmF5IGxlbmd0aFxuICAgKi9cbiAgZ2V0UGFnZXMoY3VycmVudFBhZ2U6IG51bWJlciwgaXRlbXNQZXJQYWdlOiBudW1iZXIsIHRvdGFsSXRlbXM6IG51bWJlcik6IGFueSB7XG4gICAgY29uc3QgcGFnZXM6IGFueSA9IFtdO1xuXG4gICAgLy8gRGVmYXVsdCBwYWdlIGxpbWl0c1xuICAgIGNvbnN0IHRvdGFsUGFnZXM6IG51bWJlciA9IHRoaXMubGFzdFBhZ2UgPSBNYXRoLmNlaWwodG90YWxJdGVtcyAvIGl0ZW1zUGVyUGFnZSk7XG5cbiAgICBsZXQgc3RhcnRQYWdlID0gMTtcbiAgICBsZXQgZW5kUGFnZTogbnVtYmVyID0gdG90YWxQYWdlcztcbiAgICBjb25zdCBpc01heFNpemVkOiBib29sZWFuID0gdGhpcy5tYXhTaXplICYmIHRoaXMubWF4U2l6ZSA8IHRvdGFsUGFnZXM7XG5cbiAgICAvLyByZWNvbXB1dGUgaWYgbWF4U2l6ZVxuICAgIGlmIChpc01heFNpemVkKSB7XG5cbiAgICAgIGlmICh0aGlzLnJvdGF0ZSkge1xuXG4gICAgICAgIC8vIGN1cnJlbnQgcGFnZSBpcyBkaXNwbGF5ZWQgaW4gdGhlIG1pZGRsZSBvZiB0aGUgdmlzaWJsZSBvbmVzXG4gICAgICAgIHN0YXJ0UGFnZSA9IE1hdGgubWF4KGN1cnJlbnRQYWdlIC0gTWF0aC5mbG9vcih0aGlzLm1heFNpemUgLyAyKSwgMSk7XG4gICAgICAgIGVuZFBhZ2UgPSBzdGFydFBhZ2UgKyB0aGlzLm1heFNpemUgLSAxO1xuXG4gICAgICAgIC8vIEFkanVzdCBpZiBsaW1pdCBpcyBleGNlZWRlZFxuICAgICAgICBpZiAoZW5kUGFnZSA+IHRvdGFsUGFnZXMpIHtcbiAgICAgICAgICBlbmRQYWdlID0gdG90YWxQYWdlcztcbiAgICAgICAgICBzdGFydFBhZ2UgPSBlbmRQYWdlIC0gdGhpcy5tYXhTaXplICsgMTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVmlzaWJsZSBwYWdlcyBhcmUgcGFnaW5hdGVkIHdpdGggbWF4U2l6ZVxuICAgICAgICBzdGFydFBhZ2UgPSAoTWF0aC5jZWlsKGN1cnJlbnRQYWdlIC8gdGhpcy5tYXhTaXplKSAtIDEpICogdGhpcy5tYXhTaXplICsgMTtcblxuICAgICAgICAvLyBhZGp1c3QgbGFzdCBwYWdlIGlmIGxpbWl0IGlzIGV4Y2VlZGVkXG4gICAgICAgIGVuZFBhZ2UgPSBNYXRoLm1pbihzdGFydFBhZ2UgKyB0aGlzLm1heFNpemUgLSAxLCB0b3RhbFBhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBhZGQgcGFnZSBudW1iZXIgbGlua3NcbiAgICBmb3IgKGxldCBwYWdlTnVtYmVyID0gc3RhcnRQYWdlOyBwYWdlTnVtYmVyIDw9IGVuZFBhZ2U7IHBhZ2VOdW1iZXIrKykge1xuICAgICAgY29uc3QgcGFnZSA9IHRoaXMubWFrZVBhZ2UocGFnZU51bWJlciwgcGFnZU51bWJlciwgcGFnZU51bWJlciA9PT0gY3VycmVudFBhZ2UpO1xuICAgICAgcGFnZXMucHVzaChwYWdlKTtcbiAgICB9XG5cbiAgICAvLyBhZGQgbGlua3MgdG8gbW92ZSBiZXR3ZWVuIHBhZ2Ugc2V0c1xuICAgIGlmIChpc01heFNpemVkICYmIHRoaXMubWF4U2l6ZSA+IDAgJiYgKCF0aGlzLnJvdGF0ZSB8fCB0aGlzLmZvcmNlRWxsaXBzZXMgfHwgdGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzKSkge1xuICAgICAgaWYgKHN0YXJ0UGFnZSA+IDEpIHtcblxuICAgICAgICAvLyBuZWVkIGVsbGlwc2lzIGZvciBhbGwgb3B0aW9ucyB1bmxlc3MgcmFuZ2UgaXMgdG9vIGNsb3NlIHRvIGJlZ2lubmluZ1xuICAgICAgICBpZiAoIXRoaXMuYm91bmRhcnlMaW5rTnVtYmVycyB8fCBzdGFydFBhZ2UgPiAzKSB7XG4gICAgICAgICAgY29uc3QgcHJldmlvdXNQYWdlU2V0ID0gdGhpcy5tYWtlUGFnZShzdGFydFBhZ2UgLSAxLCAnLi4uJywgZmFsc2UpO1xuICAgICAgICAgIHBhZ2VzLnVuc2hpZnQocHJldmlvdXNQYWdlU2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmJvdW5kYXJ5TGlua051bWJlcnMpIHtcblxuICAgICAgICAgIGlmIChzdGFydFBhZ2UgPT09IDMpIHsgLy8gbmVlZCB0byByZXBsYWNlIGVsbGlwc2lzIHdoZW4gdGhlIGJ1dHRvbnMgd291bGQgYmUgc2VxdWVudGlhbFxuICAgICAgICAgICAgY29uc3Qgc2Vjb25kUGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKDIsICcyJywgZmFsc2UpO1xuICAgICAgICAgICAgcGFnZXMudW5zaGlmdChzZWNvbmRQYWdlTGluayk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gYWRkIHRoZSBmaXJzdCBwYWdlXG4gICAgICAgICAgY29uc3QgZmlyc3RQYWdlTGluayA9IHRoaXMubWFrZVBhZ2UoMSwgJzEnLCBmYWxzZSk7XG4gICAgICAgICAgcGFnZXMudW5zaGlmdChmaXJzdFBhZ2VMaW5rKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZW5kUGFnZSA8IHRvdGFsUGFnZXMpIHtcblxuICAgICAgICAvLyBuZWVkIGVsbGlwc2lzIGZvciBhbGwgb3B0aW9ucyB1bmxlc3MgcmFuZ2UgaXMgdG9vIGNsb3NlIHRvIGVuZFxuICAgICAgICBpZiAoIXRoaXMuYm91bmRhcnlMaW5rTnVtYmVycyB8fCBlbmRQYWdlIDwgdG90YWxQYWdlcyAtIDIpIHtcbiAgICAgICAgICBjb25zdCBuZXh0UGFnZVNldCA9IHRoaXMubWFrZVBhZ2UoZW5kUGFnZSArIDEsICcuLi4nLCBmYWxzZSk7XG4gICAgICAgICAgcGFnZXMucHVzaChuZXh0UGFnZVNldCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzKSB7XG5cbiAgICAgICAgICBpZiAoZW5kUGFnZSA9PT0gdG90YWxQYWdlcyAtIDIpIHsgLy8gbmVlZCB0byByZXBsYWNlIGVsbGlwc2lzIHdoZW4gdGhlIGJ1dHRvbnMgd291bGQgYmUgc2VxdWVudGlhbFxuICAgICAgICAgICAgY29uc3Qgc2Vjb25kVG9MYXN0UGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKHRvdGFsUGFnZXMgLSAxLCB0b3RhbFBhZ2VzIC0gMSwgZmFsc2UpO1xuICAgICAgICAgICAgcGFnZXMucHVzaChzZWNvbmRUb0xhc3RQYWdlTGluayk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gYWRkIHRoZSBsYXN0IHBhZ2VcbiAgICAgICAgICBjb25zdCBsYXN0UGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKHRvdGFsUGFnZXMsIHRvdGFsUGFnZXMsIGZhbHNlKTtcbiAgICAgICAgICBwYWdlcy5wdXNoKGxhc3RQYWdlTGluayk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHBhZ2luYXRpb24gY29tcG9uZW50XG4gICAqL1xuICB1cGRhdGVQYWdlcygpOiB2b2lkIHtcbiAgICBjb25zdCBpbnN0YW5jZTogQW5ndWxhclBhZ2luYXRvckluc3RhbmNlID0gdGhpcy5hbmd1bGFyUGFnaW5hdG9yU2VydmljZS5nZXRJbnN0YW5jZSh0aGlzLmlkKTtcblxuICAgIGNvbnN0IGNvcnJlY3RlZEN1cnJlbnRQYWdlID0gdGhpcy5vdXRPZkJvdW5kQ29ycmVjdGlvbihpbnN0YW5jZSk7XG5cbiAgICBpZiAoY29ycmVjdGVkQ3VycmVudFBhZ2UgIT09IGluc3RhbmNlLmN1cnJlbnRQYWdlIHx8IHRoaXMuY3VycmVudFBhZ2UgIT09IGluc3RhbmNlLmN1cnJlbnRQYWdlKSB7XG4gICAgICB0aGlzLnNldEN1cnJlbnRQYWdlKGNvcnJlY3RlZEN1cnJlbnRQYWdlKTtcbiAgICB9XG5cbiAgICB0aGlzLnBhZ2VzID0gdGhpcy5nZXRQYWdlcyhpbnN0YW5jZS5jdXJyZW50UGFnZSwgaW5zdGFuY2UuaXRlbXNQZXJQYWdlLCBpbnN0YW5jZS50b3RhbEl0ZW1zKTtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjdXJyZW50UGFnZSBpcyBvdXQgb2YgYm91bmQgd2l0aCB0b3RhbFBhZ2VzXG4gICAqXG4gICAqIEBwYXJhbSBpbnN0YW5jZSBpbnN0YW5jZSBmb3Igd2hpY2ggdGhlIHJhbmdlIGlzIHRvIGJlIGNvcnJlY3RlZFxuICAgKi9cbiAgb3V0T2ZCb3VuZENvcnJlY3Rpb24oaW5zdGFuY2U6IEFuZ3VsYXJQYWdpbmF0b3JJbnN0YW5jZSk6IG51bWJlciB7XG5cbiAgICBjb25zdCB0b3RhbFBhZ2VzID0gTWF0aC5jZWlsKGluc3RhbmNlLnRvdGFsSXRlbXMgLyBpbnN0YW5jZS5pdGVtc1BlclBhZ2UpO1xuXG4gICAgaWYgKHRvdGFsUGFnZXMgPCBpbnN0YW5jZS5jdXJyZW50UGFnZSAmJiAwIDwgdG90YWxQYWdlcykge1xuICAgICAgcmV0dXJuIHRvdGFsUGFnZXM7XG4gICAgfSBlbHNlIGlmIChpbnN0YW5jZS5jdXJyZW50UGFnZSA8IDEpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cblxuICAgIHJldHVybiBpbnN0YW5jZS5jdXJyZW50UGFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjaGVjayBpZiB0aGVyZSBpcyBhbnkgaW5zdGFuY2UgcmVnaXN0ZXJlZCB3aXRoIHRoZSBpZFxuICAgKi9cbiAgaXNWYWxpZElkKCk6IHZvaWQge1xuXG4gICAgaWYgKCF0aGlzLmFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlLmdldEluc3RhbmNlKHRoaXMuaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGluc3RhbmNlIHJlZ2lzdGVyZWQgd2l0aCBpZCBgJyArIHRoaXMuaWQgKyAnYCcpO1xuICAgIH1cblxuICAgIHJldHVybjtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaXNWYWxpZElkKCk7XG4gICAgdGhpcy51cGRhdGVQYWdlcygpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgLyoqIGRlc3Ryb3kgdGhlIHN1YnNjcmlwdGlvbiB3aGVuIHRoZSBkaXJlY3RpdmUgaXMgZGVzdHJveWVkICovXG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG59XG4iXX0=